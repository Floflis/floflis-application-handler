#!/bin/sh

SCRIPTPATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"

application_name="$(basename "$1")"
application_name="$(tar -zxvOf central.apps manifest.webapp | jq -r '.id')" # credits: https://www.unix.com/34764-post2.html

# Description: handle .apps or .game applications when trying to open them. Offer to install or simply run

#if [ "$1" != "" ]; then
if [ "$(echo ${application_name##*.})" = "apps" ] || [ "$(echo ${application_name##*.})" = "game" ]; then
   mkdir /tmp/floflis
   mkdir /tmp/floflis/openned-applications
   mkdir /tmp/floflis/openned-applications/apps
   mkdir /tmp/floflis/openned-applications/games

   if [ "$(echo ${application_name##*.})" = "apps" ]; then
      open_tmp_path="/tmp/floflis/openned-applications/apps"
      application_type="app"
fi

   if [ "$(echo ${application_name##*.})" = "game" ]; then
      open_tmp_path="/tmp/floflis/openned-applications/games"
      application_type="game"
fi

   tar -C $open_tmp_path -xzf "$1"
   cd "$open_tmp_path/application"
   current_app="$(ls "$open_tmp_path/application")"
   cp -r -f --preserve=all . "$open_tmp_path"
   cd ..
   rm -r "application"
   cd "$current_app"
   floflis-packager c2 initpreview
   cd ..
   #if zenity --question --title "Install $current_app?" --width 500 --height 100 --text "You could open this app without needing to doubleclick the \"$application_name\" file. Do you want to install \"$current_app\"?";then
   #if zenity --question --title "Install $current_app?" --width 500 --height 100 --text "You could open this app without needing to doubleclick the \"$application_name\" file. Do you want to install \"$current_app\"?" --icon-name="central";then
   if zenity --question --title "Install $current_app?" --width 500 --height 100 --text "You could open this $application_type without needing to doubleclick the \"$application_name\" file. Do you want to install \"$current_app\"?" --icon-name="central";then
      #mv "$current_app" /1/apps
      #if mv "$current_app" /1/apps; then echo "Moved";exit 0; else echo "Couldn't move";exit 0; fi
      if mv "$current_app" /1/apps; then notify-send "From $application_name, \"$current_app\" has been successfully installed!";exit 0; else notify-send "Couldn't install \"$current_app\" from $application_name. Possibly this is already installed and couldn't be overwritten." --icon="error";rm -r "$current_app";rm manifest.webapp;exit 0; fi
      #notify-send "From $application_name, \"$current_app\" has been successfully installed!"
      exit 0
   else
      rm -r "$current_app"
      rm manifest.webapp
      exit 0
fi
else
   echo "---- Floflis Application Handler ----"
   echo "The file you tried to open isn't a Floflis application."
   echo "Floflis applications are .apps or .game files."
fi

if [ "$1" = "babyisalive" ]; then
   exit 0
fi
